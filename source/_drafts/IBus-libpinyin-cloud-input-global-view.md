---
title: 云输入在 ibus-libpinyin 中的实现 - 概述
date: 2020-05-31 23:55:00
tags:
- IBus
- ibus-libpinyin
- Cloud Input
categories:
- ibus-libpinyin
---

在 2018 年的 Google Summer of Code (GSoC)中， ibus-libpinyin 的云输入功能由 Linyu Xu 首次引入。由于没有完全完成需求，达到最佳的用户体验，该版本并没有被合并入主分支中。本文将其称为 18 版云输入。

18 版采用了同步请求候选词的模式，也就是说，发送请求、解析请求的过程会阻塞 ibus-libpinyin 的行为，在网络情况不好时，就会让人感觉到十分卡顿，出现未响应的现象。同时，由于返回结果解析采用了比较简易的字符串提取，导致取出候选的实现健壮性不高。一系列原因导致 18 版云输入并不能作为一个生产环境可用的功能。

今年（2020），我的 GSoC 项目目标之一就是优化该功能，并将其合并入 ibus-libpinyin 的主分支中。

目前正在迭代的一系列版本在改文中被统称为 20 版云输入，本文将对云输入按照时间顺序进行一个介绍，让读者对云输入功能有一个概览。

# 当用户按下按钮

在 ibus-libpinyin 中，用户进行输入之后，编辑器的实例 `PhoneticEditor` 会调用 `updateCandidates` 方法。在该方法中，每一种候选词实例的 `processCandidates` 方法都会被调用，修改候选词列表。

云输入部分的候选词处理由 `PYPCloudCandidates` 中的 `CloudCandidates` 完成。但这时，我们还没有云输入候选的结果，因此需要先插入占位符，方便之后进行替换，从而将云输入返回的结果加入候选词列表中。

# 添加候选词占位符

首先，`CloudCandidates` 会找到指定的位置，从该位置开始插入预先设定个数的候选词占位符。目前使用了一个云的符号☁，用来提示用户该位置是一个云输入的候选词，将会被云输入请求返回的候选词取代。

这个指定位置在 18 版云输入是由一个设置项确定的，******

同时在

一切处理结束后，`CloudCandidates` 会去调用对应的方法来请求云输入的候选，以便之后对占位符进行替换。

# 发送请求

在文章开头提到过，18 版云输入使用了

## 同步



## 异步



## 延时异步


# 18 版云输入结果处理



# 20 版云输入结果处理



## 结果解析



## 更新候选词



## 更新查询表



## 用户选择的候选的处理



# 总结

本文按照事件发生的时间顺序粗略描述了云输入功能背后发生了什么，随着版本的迭代，整体流程可能还是会发生变化，届时我会更新本文。一些部分会放在其他文章中详细描述。
