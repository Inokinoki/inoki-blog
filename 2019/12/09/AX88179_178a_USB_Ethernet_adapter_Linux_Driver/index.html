<!DOCTYPE html>
<htmlen>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <script data-ad-client="ca-pub-2713518338457470" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  <meta name="google-site-verification" content="uxeL3ivCjEkmCPEWS1owNMkK9VHPxOMCjcaMHaQ38Bo">
  <meta name="google-site-verification" content="yU7d61qsV4eAvSOazt85VJMYfiEDjZjcaXwyQKGP5Bc">
  
  
  <title>AX88179_178a USB-Ethernet adapter Linux Driver | Inoki in the world</title>
  <meta name="description" content="In this post, we’ll analyze the Linux Driver of USB-Ethernet adapters, which are using AX88179/AX88178a chips.  Introduction AX88179 and AX88178a is a chip from ASIX Electronics Corporation, which is">
<meta name="keywords" content="Linux,Linux Driver,ASIX">
<meta property="og:type" content="article">
<meta property="og:title" content="AX88179_178a USB-Ethernet adapter Linux Driver">
<meta property="og:url" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/index.html">
<meta property="og:site_name" content="Inoki in the world">
<meta property="og:description" content="In this post, we’ll analyze the Linux Driver of USB-Ethernet adapters, which are using AX88179/AX88178a chips.  Introduction AX88179 and AX88178a is a chip from ASIX Electronics Corporation, which is">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/edimax-eu-4306.jpg">
<meta property="og:image" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/name.png">
<meta property="og:image" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/rx_usb_net_packet.png">
<meta property="og:image" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/rx_net_packet.png">
<meta property="og:image" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/rx_usb_net_packet.png">
<meta property="og:updated_time" content="2022-06-28T08:52:15.935Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AX88179_178a USB-Ethernet adapter Linux Driver">
<meta name="twitter:description" content="In this post, we’ll analyze the Linux Driver of USB-Ethernet adapters, which are using AX88179/AX88178a chips.  Introduction AX88179 and AX88178a is a chip from ASIX Electronics Corporation, which is">
<meta name="twitter:image" content="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/edimax-eu-4306.jpg">
<meta name="twitter:creator" content="@IIInoki">
  <!-- Canonical links -->
  <link rel="canonical" href="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Inoki in the world" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
</head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="/" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Inoki</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Student</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Earth</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech="">
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope="" itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/book">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/inokinoki" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://twitter.com/IIInoki" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope="" itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                Welcome to Inoki's Blog. You can find my work on IME, Embedded System an more on here.
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <!--
              <p class="item-category">
                <a class="category-link" href="/categories/Linux/">Linux</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/Linux/Android/">Android</a>
              </p>
              -->
              <p class="item-title">
                <a href="/2022/05/09/android-bootloader-linux-nokia-nb1-dt/" class="title">Android Bootloader and Linux Internal based on Nokia 8(NB1) —— Device Tree</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-09T20:48:00.000Z" itemprop="datePublished">2022-05-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--
              <p class="item-category">
                <a class="category-link" href="/categories/Embedded-System/">Embedded System</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/Embedded-System/Raspberry-Pi/">Raspberry Pi</a>
              </p>
              -->
              <p class="item-title">
                <a href="/2022/02/22/My-journey-on-raspberrypi-jtag-debugging/" class="title">My journey on Raspberry Pi JTAG debugging</a>
              </p>
              <p class="item-date">
                <time datetime="2022-02-22T06:57:50.000Z" itemprop="datePublished">2022-02-22</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--
              <p class="item-category">
                <a class="category-link" href="/categories/Dairy/">Dairy</a>
              </p>
              -->
              <p class="item-title">
                <a href="/2022/02/08/My-2021/" class="title">孑然一身的 2021</a>
              </p>
              <p class="item-date">
                <time datetime="2022-02-08T16:54:40.000Z" itemprop="datePublished">2022-02-08</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--
              <p class="item-category">
                <a class="category-link" href="/categories/EDK2/">EDK2</a>
              </p>
              -->
              <p class="item-title">
                <a href="/2021/12/17/qemu-ovmf-edk2-build/" class="title">Build and run Hello World on OVMF Qemu</a>
              </p>
              <p class="item-date">
                <time datetime="2021-12-17T13:47:00.000Z" itemprop="datePublished">2021-12-17</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--
              <p class="item-category">
                <a class="category-link" href="/categories/Modern-C/">Modern C++</a>
              </p>
              -->
              <p class="item-title">
                <a href="/2021/12/16/My_tutorial_and_take_on_C++20_coroutines/" class="title">【译】我的 C++ 20 协程的予取予求</a>
              </p>
              <p class="item-date">
                <time datetime="2021-12-16T15:34:00.000Z" itemprop="datePublished">2021-12-16</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2713518338457470" crossorigin="anonymous"></script>
<!-- Blog sidebar -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2713518338457470" data-ad-slot="2343090796" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
  

    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/ABL/" style="font-size: 13.56px;">ABL</a> <a href="/tags/ASIX/" style="font-size: 13.11px;">ASIX</a> <a href="/tags/Aboot/" style="font-size: 13.22px;">Aboot</a> <a href="/tags/Algorithm/" style="font-size: 13px;">Algorithm</a> <a href="/tags/Android/" style="font-size: 13.67px;">Android</a> <a href="/tags/Bare-Metal/" style="font-size: 13.11px;">Bare Metal</a> <a href="/tags/Bootloader/" style="font-size: 13.67px;">Bootloader</a> <a href="/tags/Bug/" style="font-size: 13.22px;">Bug</a> <a href="/tags/C/" style="font-size: 13px;">C++</a> <a href="/tags/Chrome-OS/" style="font-size: 13px;">Chrome OS</a> <a href="/tags/Cloud-Input/" style="font-size: 13.33px;">Cloud Input</a> <a href="/tags/Computer-Graphics/" style="font-size: 13px;">Computer Graphics</a> <a href="/tags/Craft/" style="font-size: 13.11px;">Craft</a> <a href="/tags/Cross-Compile/" style="font-size: 13.22px;">Cross Compile</a> <a href="/tags/Cuda/" style="font-size: 13px;">Cuda</a> <a href="/tags/Debian/" style="font-size: 13px;">Debian</a> <a href="/tags/Debug/" style="font-size: 13.11px;">Debug</a> <a href="/tags/Docker/" style="font-size: 13px;">Docker</a> <a href="/tags/Dynamic-Programming/" style="font-size: 13px;">Dynamic Programming</a> <a href="/tags/EDK2/" style="font-size: 13px;">EDK2</a> <a href="/tags/EFI/" style="font-size: 13px;">EFI</a> <a href="/tags/Embedded-System/" style="font-size: 13.44px;">Embedded System</a> <a href="/tags/FFmpeg/" style="font-size: 13.11px;">FFmpeg</a> <a href="/tags/GBDK/" style="font-size: 13.11px;">GBDK</a> <a href="/tags/GDB/" style="font-size: 13px;">GDB</a> <a href="/tags/Go/" style="font-size: 13.11px;">Go</a> <a href="/tags/HTTP/" style="font-size: 13px;">HTTP</a> <a href="/tags/Hash/" style="font-size: 13px;">Hash</a> <a href="/tags/Heterogeneous-Computing/" style="font-size: 13px;">Heterogeneous Computing</a> <a href="/tags/IBus/" style="font-size: 13.44px;">IBus</a> <a href="/tags/IME/" style="font-size: 13px;">IME</a> <a href="/tags/IoT/" style="font-size: 13.44px;">IoT</a> <a href="/tags/JTAG/" style="font-size: 13px;">JTAG</a> <a href="/tags/KDE/" style="font-size: 13.11px;">KDE</a> <a href="/tags/KDE-Connect/" style="font-size: 13.67px;">KDE Connect</a> <a href="/tags/KDE-Frameworks/" style="font-size: 13.11px;">KDE Frameworks</a> <a href="/tags/Leetcode/" style="font-size: 13px;">Leetcode</a> <a href="/tags/Linux/" style="font-size: 13.78px;">Linux</a> <a href="/tags/Linux-Driver/" style="font-size: 13.22px;">Linux Driver</a> <a href="/tags/LoRa/" style="font-size: 13.44px;">LoRa</a> <a href="/tags/LoRaWAN/" style="font-size: 13.44px;">LoRaWAN</a> <a href="/tags/Man/" style="font-size: 13px;">Man</a> <a href="/tags/OpenCL/" style="font-size: 13px;">OpenCL</a> <a href="/tags/Pack/" style="font-size: 13px;">Pack</a> <a href="/tags/Python/" style="font-size: 13.11px;">Python</a> <a href="/tags/QUIC/" style="font-size: 13px;">QUIC</a> <a href="/tags/Qemu/" style="font-size: 13px;">Qemu</a> <a href="/tags/Qt/" style="font-size: 13.11px;">Qt</a> <a href="/tags/Raspberry-Pi/" style="font-size: 13.44px;">Raspberry Pi</a> <a href="/tags/Ray-Tracing/" style="font-size: 13px;">Ray Tracing</a> <a href="/tags/Router/" style="font-size: 13.22px;">Router</a> <a href="/tags/Rust/" style="font-size: 13px;">Rust</a> <a href="/tags/SDDM/" style="font-size: 13px;">SDDM</a> <a href="/tags/SDR/" style="font-size: 13.33px;">SDR</a> <a href="/tags/Source-Code/" style="font-size: 13.11px;">Source Code</a> <a href="/tags/System/" style="font-size: 13px;">System</a> <a href="/tags/UART/" style="font-size: 13px;">UART</a> <a href="/tags/Ubuntu/" style="font-size: 13.11px;">Ubuntu</a> <a href="/tags/VSCode/" style="font-size: 13px;">VSCode</a> <a href="/tags/Visual-Studio/" style="font-size: 13px;">Visual Studio</a> <a href="/tags/Vulkan/" style="font-size: 13px;">Vulkan</a> <a href="/tags/WSL/" style="font-size: 13px;">WSL</a> <a href="/tags/Win-10-ARM/" style="font-size: 13px;">Win 10 ARM</a> <a href="/tags/Win-10-IoT/" style="font-size: 13.11px;">Win 10 IoT</a> <a href="/tags/Windows/" style="font-size: 13.11px;">Windows</a> <a href="/tags/XBL/" style="font-size: 13px;">XBL</a> <a href="/tags/epoll/" style="font-size: 13px;">epoll</a> <a href="/tags/iOS/" style="font-size: 13px;">iOS</a> <a href="/tags/ibus-libpinyin/" style="font-size: 13.33px;">ibus-libpinyin</a> <a href="/tags/macOS/" style="font-size: 13px;">macOS</a> <a href="/tags/openwrt/" style="font-size: 13px;">openwrt</a> <a href="/tags/private/" style="font-size: 13.22px;">private</a> <a href="/tags/sysfs/" style="font-size: 13px;">sysfs</a> <a href="/tags/中文/" style="font-size: 14px;">中文</a> <a href="/tags/翻译/" style="font-size: 13.89px;">翻译</a> <a href="/tags/驱动/" style="font-size: 13px;">驱动</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ABL/">ABL</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASIX/">ASIX</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aboot/">Aboot</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/">Algorithm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bare-Metal/">Bare Metal</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bootloader/">Bootloader</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bug/">Bug</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome-OS/">Chrome OS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud-Input/">Cloud Input</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Computer-Graphics/">Computer Graphics</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Craft/">Craft</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cross-Compile/">Cross Compile</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cuda/">Cuda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debian/">Debian</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debug/">Debug</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dynamic-Programming/">Dynamic Programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EDK2/">EDK2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EFI/">EFI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Embedded-System/">Embedded System</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GBDK/">GBDK</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDB/">GDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hash/">Hash</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heterogeneous-Computing/">Heterogeneous Computing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IBus/">IBus</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IME/">IME</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IoT/">IoT</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JTAG/">JTAG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDE/">KDE</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDE-Connect/">KDE Connect</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KDE-Frameworks/">KDE Frameworks</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode/">Leetcode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Driver/">Linux Driver</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LoRa/">LoRa</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LoRaWAN/">LoRaWAN</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Man/">Man</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCL/">OpenCL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pack/">Pack</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/QUIC/">QUIC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qemu/">Qemu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt/">Qt</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raspberry-Pi/">Raspberry Pi</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ray-Tracing/">Ray Tracing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Router/">Router</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rust/">Rust</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDDM/">SDDM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDR/">SDR</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Source-Code/">Source Code</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/">System</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UART/">UART</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/">VSCode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Visual-Studio/">Visual Studio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vulkan/">Vulkan</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WSL/">WSL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Win-10-ARM/">Win 10 ARM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Win-10-IoT/">Win 10 IoT</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XBL/">XBL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/">epoll</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ibus-libpinyin/">ibus-libpinyin</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macOS/">macOS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openwrt/">openwrt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/private/">private</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysfs/">sysfs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/中文/">中文</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/翻译/">翻译</a><span class="tag-list-count">25</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/驱动/">驱动</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/Hash/">Hash</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Bug/">Bug</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Bug/Cuda/">Cuda</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Bug/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Bug/Linux-Driver/">Linux Driver</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Bug/WSL/">WSL</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Build/">Build</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Chinese/">Chinese</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Chrome-OS/">Chrome OS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Computer-Graphics/">Computer Graphics</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Computer-Graphics/Vulkan/">Vulkan</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dairy/">Dairy</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/Algorithm/">Algorithm</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/EDK2/">EDK2</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Embedded-System/">Embedded System</a><span class="category-list-count">9</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Embedded-System/Cross-Compile/">Cross Compile</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Embedded-System/Cross-Compile/Router/">Router</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Embedded-System/IoT/">IoT</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Embedded-System/IoT/Win-10-IoT/">Win 10 IoT</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Embedded-System/Raspberry-Pi/">Raspberry Pi</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/FFmpeg/">FFmpeg</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GBDK/">GBDK</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IME/">IME</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Inoki-Home-Made/">Inoki Home Made</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Inoki-Home-Made/Qt/">Qt</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Inoki-Home-Made/Qt/EFI/">EFI</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/KDE/">KDE</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/KDE/Craft/">Craft</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/KDE/Craft/Blueprints/">Blueprints</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/KDE-Connect/">KDE Connect</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/KDE-Connect/中文/">中文</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/KDE-Frameworks/">KDE Frameworks</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/">Leetcode</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Leetcode/Dynamic-Programming/">Dynamic Programming</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">17</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Android/">Android</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Android/Bootloader/">Bootloader</a><span class="category-list-count">8</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Driver/">Driver</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Wayland/">Wayland</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/man/">man</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/man/7-Miscellanea/">7-Miscellanea</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/sysfs/">sysfs</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux-Driver/">Linux Driver</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LoRa/">LoRa</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Modern-C/">Modern C++</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenCL/">OpenCL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Package/">Package</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Package/Debian/">Debian</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Programming-Language/">Programming Language</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Programming-Language/Python/">Python</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Protocol/">Protocol</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Qt/">Qt</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Rust/">Rust</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SDR/">SDR</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Source-Code/">Source Code</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Source-Code/Linux-Driver/">Linux Driver</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Source-Code/Linux-Driver/USB-Net/">USB-Net</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Source-Code/Python/">Python</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/System/Utility/">Utility</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/System/Utility/Build-tool/">Build tool</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Translation/">Translation</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Translation/Chinese/">Chinese</a><span class="category-list-count">15</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/VSCode/">VSCode</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ibus-libpinyin/">ibus-libpinyin</a><span class="category-list-count">4</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-AX88179_178a_USB_Ethernet_adapter_Linux_Driver" class="article article-type-post" itemscope="" itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      AX88179_178a USB-Ethernet adapter Linux Driver
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/" class="article-date">
	  <time datetime="2019-12-09T10:52:00.000Z" itemprop="datePublished">2019-12-09</time>
	</a>
</span>

        
<!--
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Linux-Driver/">Linux Driver</a>►<a class="article-category-link" href="/categories/Source-Code/">Source Code</a>►<a class="article-category-link" href="/categories/Source-Code/Linux-Driver/">Linux Driver</a>►<a class="article-category-link" href="/categories/Source-Code/Linux-Driver/USB-Net/">USB-Net</a>
  </span>
-->

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/ASIX/">ASIX</a>, <a class="article-tag-link" href="/tags/Linux/">Linux</a>, <a class="article-tag-link" href="/tags/Linux-Driver/">Linux Driver</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/#comments" class="article-comment-link">Comments</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 3.3k(words)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 20(minutes)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>In this post, we’ll analyze the Linux Driver of USB-Ethernet adapters, which are using <code>AX88179</code>/<code>AX88178a</code> chips.</p>
<h1 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h1>
<p><code>AX88179</code> and <code>AX88178a</code> is a chip from ASIX Electronics Corporation, which is a leading fabless semiconductor supplier with focus on networking, communication and connectivity applications, founded in May 1995 in Hsinchu Science Park, Taiwan.</p>
<p><code>AX88179</code> is a USB3.0 to 10/100/1000M Gigabit Ethernet Controller, and <code>AX88178a</code> is the one for USB2.0. Since there are still lots of devices which are using USB 2.0, they are usually integrated into one single adapter to provide backward-compatibility.</p>
<p>More information about the chips can be found on the offcial website of ASIX:</p>
<ul>
<li><a href="https://www.asix.com.tw/products.php?op=pItemdetail&amp;PItemID=131;71;112" target="_blank" rel="noopener">AX88179</a></li>
<li><a href="https://www.asix.com.tw/products.php?op=pItemdetail&amp;PItemID=134;71;100" target="_blank" rel="noopener">AX88178a</a></li>
</ul>
<p>The one which I’m using is an adapter from <code>Edimax</code>, named <code>Edimax EU-4306 Adaptateur USB Ethernet</code>.</p>
<img src="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/edimax-eu-4306.jpg" title="Edimax EU-4306 Adaptateur USB Ethernet">
<p>Everyone can buy it with a fair price - about 25 euros in France.</p>
<h1 id="driver-selection"><a class="markdownIt-Anchor" href="#driver-selection"></a> Driver Selection</h1>
<p>The source code of the driver in current version kernel is located at <code>drivers/net/usb/ax88179_178a.c</code>.</p>
<p>Its <a href="https://github.com/torvalds/linux/commit/e2ca90c276e1fc410d7cd3c1a4eee245ec902a20#diff-f2b04890e4605b9554cc77093cfc9e2a" target="_blank" rel="noopener">first commit</a> is on Mar 2, 2013. So, up to now, we should be able to use it without panic.</p>
<p>To validate that it can be rightly loaded in your system, just plug in. Use this command to find information of your device and the software assoiated with it:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; usb-devices</span><br><span class="line">...</span><br><span class="line">T:  Bus=02 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#=  2 Spd=5000 MxCh= 0</span><br><span class="line">D:  Ver= 3.00 Cls=ff(vend.) Sub=ff Prot=00 MxPS= 9 #Cfgs=  1</span><br><span class="line">P:  Vendor=0b95 ProdID=1790 Rev=01.00</span><br><span class="line">S:  Manufacturer=ASIX Elec. Corp.</span><br><span class="line">S:  Product=AX88179</span><br><span class="line">S:  SerialNumber=xxxxxx</span><br><span class="line">C:  #Ifs= 1 Cfg#= 1 Atr=a0 MxPwr=496mA</span><br><span class="line">I:  If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=00 Driver=ax88179_178a</span><br></pre></td></tr></table></figure>
<p>We can see at the last line, there is <code>Driver=ax88179_178a</code>, which means my device uses the right driver.</p>
<p>To associate a device and a usb driver, one important thing is the vendor ID and product ID, showing in the third line: <code>Vendor=0b95 ProdID=1790</code>.</p>
<p>So, if your device cannot be allocated with an appropriate driver, pleas check the vendor ID and product ID of it.</p>
<p>The ID table of compatible devices for AX88179/178a is defined as below:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_id</span> <span class="title">products</span>[] = &#123;</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* ASIX AX88179 10/100/1000 */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x0b95</span>, <span class="number">0x1790</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;ax88179_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* ASIX AX88178A 10/100/1000 */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x0b95</span>, <span class="number">0x178a</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;ax88178a_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* Cypress GX3 SuperSpeed to Gigabit Ethernet Bridge Controller */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x04b4</span>, <span class="number">0x3610</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;cypress_GX3_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* D-Link DUB-1312 USB 3.0 to Gigabit Ethernet Adapter */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x2001</span>, <span class="number">0x4a00</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;dlink_dub1312_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* Sitecom USB 3.0 to Gigabit Adapter */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x0df6</span>, <span class="number">0x0072</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;sitecom_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* Samsung USB Ethernet Adapter */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x04e8</span>, <span class="number">0xa100</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;samsung_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* Lenovo OneLinkDock Gigabit LAN */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x17ef</span>, <span class="number">0x304b</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;lenovo_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* Belkin B2B128 USB 3.0 Hub + Gigabit Ethernet Adapter */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x050d</span>, <span class="number">0x0128</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;belkin_info,</span><br><span class="line">&#125;,</span><br><span class="line">	&#123; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(usb, products);</span><br></pre></td></tr></table></figure>
<p>Notice that <code>USB_DEVICE</code> is a macro defined in <code>include/linux/usb.h</code>, to quickly assign vendor ID and product ID. Meanwhile, make the mode be strictly matching, which means that only device has this vendor ID <strong>AND</strong> product ID will be allowed to use this driver.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USB_DEVICE(vend, prod) \</span></span><br><span class="line">	.match_flags = USB_DEVICE_ID_MATCH_DEVICE, \</span><br><span class="line">	.idVendor = (vend), \</span><br><span class="line">	.idProduct = (prod)</span><br></pre></td></tr></table></figure>
<p>More, <code>products</code> is a table of type <code>struct usb_device_id</code>, defined in <code>include/linux/mod_devicetable.h</code>. Since we’ve already included <code>include/linux/usb.h\(&lt;linux/usb.h&gt;\)</code>, we do not need import it once more.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device_id</span> &#123;</span></span><br><span class="line">	<span class="comment">/* which fields to match against? */</span></span><br><span class="line">	__u16		match_flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Used for product specific matches; range is inclusive */</span></span><br><span class="line">	__u16		idVendor;</span><br><span class="line">	__u16		idProduct;</span><br><span class="line">	__u16		bcdDevice_lo;</span><br><span class="line">	__u16		bcdDevice_hi;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Used for device class matches */</span></span><br><span class="line">	__u8		bDeviceClass;</span><br><span class="line">	__u8		bDeviceSubClass;</span><br><span class="line">	__u8		bDeviceProtocol;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Used for interface class matches */</span></span><br><span class="line">	__u8		bInterfaceClass;</span><br><span class="line">	__u8		bInterfaceSubClass;</span><br><span class="line">	__u8		bInterfaceProtocol;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Used for vendor-specific interface matches */</span></span><br><span class="line">	__u8		bInterfaceNumber;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* not matched against */</span></span><br><span class="line">	<span class="keyword">kernel_ulong_t</span>	driver_info</span><br><span class="line">		__attribute__((aligned(<span class="keyword">sizeof</span>(<span class="keyword">kernel_ulong_t</span>))));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>But, if yours is not one of them, it might be another device. This post will have limited usage to you.</p>
<h1 id="driver-module-registration"><a class="markdownIt-Anchor" href="#driver-module-registration"></a> Driver module registration</h1>
<p>To make system be able to allocate the right driver, we need register the driver.</p>
<h2 id="usb_driver-structure"><a class="markdownIt-Anchor" href="#usb_driver-structure"></a> usb_driver structure</h2>
<p>The structure to describe a driver for USB is defined in <code>include/linux/usb.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_driver</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*probe) (struct usb_interface *intf,</span><br><span class="line">		      <span class="keyword">const</span> struct usb_device_id *id);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> (*<span class="built_in">disconnect</span>) (struct usb_interface *intf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*unlocked_ioctl) (struct usb_interface *intf, <span class="keyword">unsigned</span> <span class="keyword">int</span> code,</span><br><span class="line">			<span class="keyword">void</span> *buf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*suspend) (struct usb_interface *intf, <span class="keyword">pm_message_t</span> message);</span><br><span class="line">	<span class="keyword">int</span> (*resume) (struct usb_interface *intf);</span><br><span class="line">	<span class="keyword">int</span> (*reset_resume)(struct usb_interface *intf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> (*pre_reset)(struct usb_interface *intf);</span><br><span class="line">	<span class="keyword">int</span> (*post_reset)(struct usb_interface *intf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">dev_groups</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usb_dynids</span> <span class="title">dynids</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usbdrv_wrap</span> <span class="title">drvwrap</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> no_dynamic_id:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> supports_autosuspend:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> disable_hub_initiated_lpm:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> soft_unbind:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>It’s a huge one, but we need not define all of them. What we need is just:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_driver</span> <span class="title">ax88179_178a_driver</span> = &#123;</span></span><br><span class="line">	.name =		<span class="string">"ax88179_178a"</span>,</span><br><span class="line">	.id_table =	products,</span><br><span class="line">	.probe =	usbnet_probe,</span><br><span class="line">	.suspend =	ax88179_suspend,</span><br><span class="line">	.resume =	ax88179_resume,</span><br><span class="line">	.reset_resume =	ax88179_resume,</span><br><span class="line">	.<span class="built_in">disconnect</span> =	usbnet_disconnect,</span><br><span class="line">	.supports_autosuspend = <span class="number">1</span>,</span><br><span class="line">	.disable_hub_initiated_lpm = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="name"><a class="markdownIt-Anchor" href="#name"></a> .name</h3>
<p>This is the name of driver, and it will be shown at the last line of the output of usb-devices.</p>
<img src="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/name.png" title="USB driver name">
<p>I got the output above by changing the name to <code>ax88179_178a_inoki</code>.</p>
<h3 id="struct-usb_interface-intf"><a class="markdownIt-Anchor" href="#struct-usb_interface-intf"></a> struct usb_interface *intf</h3>
<p>We can see that many of fields are pointers to functions with an argument of type <code>struct usb_interface *intf</code>.</p>
<p>It’s defined in <code>include/linux/usb.h</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_interface</span> &#123;</span></span><br><span class="line">	<span class="comment">/* array of alternate settings for this interface,</span></span><br><span class="line"><span class="comment">	 * stored in no particular order */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usb_host_interface</span> *<span class="title">altsetting</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usb_host_interface</span> *<span class="title">cur_altsetting</span>;</span>	<span class="comment">/* the currently</span></span><br><span class="line"><span class="comment">					 * active alternate setting */</span></span><br><span class="line">	<span class="keyword">unsigned</span> num_altsetting;	<span class="comment">/* number of alternate settings */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If there is an interface association descriptor then it will list</span></span><br><span class="line"><span class="comment">	 * the associated interfaces */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">usb_interface_assoc_descriptor</span> *<span class="title">intf_assoc</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> minor;			<span class="comment">/* minor number this interface is</span></span><br><span class="line"><span class="comment">					 * bound to */</span></span><br><span class="line">	<span class="keyword">enum</span> usb_interface_condition condition;		<span class="comment">/* state of binding */</span></span><br><span class="line">	<span class="keyword">unsigned</span> sysfs_files_created:<span class="number">1</span>;	<span class="comment">/* the sysfs attributes exist */</span></span><br><span class="line">	<span class="keyword">unsigned</span> ep_devs_created:<span class="number">1</span>;	<span class="comment">/* endpoint "devices" exist */</span></span><br><span class="line">	<span class="keyword">unsigned</span> unregistering:<span class="number">1</span>;	<span class="comment">/* unregistration is in progress */</span></span><br><span class="line">	<span class="keyword">unsigned</span> needs_remote_wakeup:<span class="number">1</span>;	<span class="comment">/* driver requires remote wakeup */</span></span><br><span class="line">	<span class="keyword">unsigned</span> needs_altsetting0:<span class="number">1</span>;	<span class="comment">/* switch to altsetting 0 is pending */</span></span><br><span class="line">	<span class="keyword">unsigned</span> needs_binding:<span class="number">1</span>;	<span class="comment">/* needs delayed unbind/rebind */</span></span><br><span class="line">	<span class="keyword">unsigned</span> resetting_device:<span class="number">1</span>;	<span class="comment">/* true: bandwidth alloc after reset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> authorized:<span class="number">1</span>;		<span class="comment">/* used for interface authorization */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span>		<span class="comment">/* interface specific device info */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">usb_dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">reset_ws</span>;</span>	<span class="comment">/* for resets in atomic context */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>With this parameter, we can distinguish which device is under operating. As well, it requires the caller pass a right reference 😃</p>
<h3 id="probe-usbnet_probe"><a class="markdownIt-Anchor" href="#probe-usbnet_probe"></a> .probe = usbnet_probe</h3>
<p>The <code>usbnet_probe</code> is a function defined in <code>include/linux/usb/usbnet.h</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">usbnet_probe</span><span class="params">(struct usb_interface *, <span class="keyword">const</span> struct usb_device_id *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>When a device is plugged into the USB bus that matches the device ID that your driver registered with the USB core, the probe function is called, with the interface instance, and the device information.</p>
<h3 id="disconnect-usbnet_disconnect"><a class="markdownIt-Anchor" href="#disconnect-usbnet_disconnect"></a> .disconnect = usbnet_disconnect</h3>
<p>Conversely, when the device is removed from the USB bus, the disconnect function is called with the device pointer.</p>
<p>For this callback and the callback which will be used in probing, the driver uses the standard USB net functions in <code>include/linux/usb/usbnet.h</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">usbnet_disconnect</span><span class="params">(struct usb_interface *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>There are lots of <strong>standard</strong> functions defined in this header file. But we cannot expect the <strong>standard</strong> stuff can handle with all devices. So, in most case, we need write our own handlers for specific devices.</p>
<h3 id="suspend-ax88179_suspend"><a class="markdownIt-Anchor" href="#suspend-ax88179_suspend"></a> .suspend = ax88179_suspend</h3>
<p>Called when the device is going to be suspended by the system either from system sleep or runtime suspend context.</p>
<p>This line can let the specific function <code>suspend</code> in the driver codebase be called.</p>
<h3 id="resume-ax88179_resume-and-reset_resume-ax88179_resume"><a class="markdownIt-Anchor" href="#resume-ax88179_resume-and-reset_resume-ax88179_resume"></a> .resume = ax88179_resume and .reset_resume = ax88179_resume</h3>
<p><code>.resume</code> will be called when the device is being resumed by the system.</p>
<p><code>.reset_resume</code> will be called when the suspended device has been reset instead of being resumed.</p>
<p>Both two can let the specific function <code>resume</code> in the driver codebase be called.</p>
<h2 id="registration"><a class="markdownIt-Anchor" href="#registration"></a> Registration</h2>
<p>Then, register the driver in the system.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module_usb_driver(ax88179_178a_driver);</span><br></pre></td></tr></table></figure>
<p>It’s not a function, but a macro defined in <code>include/linux/usb.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> module_usb_driver(__usb_driver) \</span></span><br><span class="line">	module_driver(__usb_driver, usb_register, \</span><br><span class="line">		       usb_deregister)</span><br></pre></td></tr></table></figure>
<p>Then it will be expanded to a set of instructions in <code>include/linux/device.h</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> module_driver(__driver, __register, __unregister, ...) \</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __init __driver##_init(<span class="keyword">void</span>) \</span><br><span class="line">&#123; \</span><br><span class="line">	<span class="keyword">return</span> __register(&amp;(__driver) , ##__VA_ARGS__); \</span><br><span class="line">&#125; \</span><br><span class="line">module_init(__driver##_init); \</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __exit __driver##_exit(<span class="keyword">void</span>) \</span><br><span class="line">&#123; \</span><br><span class="line">	__unregister(&amp;(__driver) , ##__VA_ARGS__); \</span><br><span class="line">&#125; \</span><br><span class="line">module_exit(__driver##_exit);</span><br></pre></td></tr></table></figure>
<p>Such instructions can control the life cycle of a driver module. But we’ll not go deeper into the module functions, becaus they are out of scope.</p>
<p>Here, we come back to the <code>module_usb_driver</code> macro. Except <code>__usb_driver</code> is the specific driven instance, <code>usb_register</code> and <code>usb_deregister</code> could be also an interesting point in this post.</p>
<p>In fact, they are defined in <code>include/linux/usb.h</code> as well:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * use these in module_init()/module_exit()</span></span><br><span class="line"><span class="comment"> * and don't forget MODULE_DEVICE_TABLE(usb, ...)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">usb_register_driver</span><span class="params">(struct usb_driver *, struct <span class="keyword">module</span> *,</span></span></span><br><span class="line"><span class="function"><span class="params">			       <span class="keyword">const</span> <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* use a define to avoid include chaining to get THIS_MODULE &amp; friends */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> usb_register(driver) \</span></span><br><span class="line">	usb_register_driver(driver, THIS_MODULE, KBUILD_MODNAME)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">usb_deregister</span><span class="params">(struct usb_driver *)</span></span>;</span><br></pre></td></tr></table></figure>
<p>The 2 functions will be called while module is being initialized or is being exited.</p>
<h1 id="core-functions"><a class="markdownIt-Anchor" href="#core-functions"></a> Core Functions</h1>
<p>After the module life cycle management, here we need talk more about the actions of driver, while there are arriving packets.</p>
<p>Except vendor ID and product ID, there is also <code>driver_info</code> field which is set according to the different devices.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* ASIX AX88179 10/100/1000 */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x0b95</span>, <span class="number">0x1790</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;ax88179_info,</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">/* ASIX AX88178A 10/100/1000 */</span></span><br><span class="line">	USB_DEVICE(<span class="number">0x0b95</span>, <span class="number">0x178a</span>),</span><br><span class="line">	.driver_info = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)&amp;ax88178a_info,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="driver-info"><a class="markdownIt-Anchor" href="#driver-info"></a> Driver Info</h2>
<p>We can take a look at the <code>0x0b95, 0x1790(AX88179)</code> and <code>0x0b95, 0x178(AX88178A)</code>. The driver info is an unsigned long pointer to the <code>struct driver_info</code> instance. Thus, Linux kernel can find the driver info instance when it needs.</p>
<p>The driver info structure is in fact a USB network driver info structure, defined in <code>include/linux/usb/usbnet.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">driver_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span>		*description;</span><br><span class="line">	<span class="keyword">int</span>		flags;</span><br><span class="line">	<span class="keyword">int</span>	(*bind)(struct usbnet *, struct usb_interface *);</span><br><span class="line">	<span class="keyword">void</span>	(*unbind)(struct usbnet *, struct usb_interface *);</span><br><span class="line">	<span class="keyword">int</span>	(*reset)(struct usbnet *);</span><br><span class="line">	<span class="keyword">int</span>	(*<span class="built_in">stop</span>)(struct usbnet *);</span><br><span class="line">	<span class="keyword">int</span>	(*check_connect)(struct usbnet *);</span><br><span class="line">	<span class="keyword">int</span>	(*manage_power)(struct usbnet *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">void</span>	(*status)(struct usbnet *, struct urb *);</span><br><span class="line">	<span class="keyword">int</span>	(*link_reset)(struct usbnet *);</span><br><span class="line">	<span class="keyword">int</span>	(*rx_fixup)(struct usbnet *dev, struct sk_buff *skb);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span>	*(*<span class="title">tx_fixup</span>)(<span class="title">struct</span> <span class="title">usbnet</span> *<span class="title">dev</span>,</span></span><br><span class="line"><span class="class">				<span class="title">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>, <span class="title">gfp_t</span> <span class="title">flags</span>);</span></span><br><span class="line">	<span class="keyword">void</span>	(*recover)(struct usbnet *dev);</span><br><span class="line">	<span class="keyword">int</span>	(*early_init)(struct usbnet *dev);</span><br><span class="line">	<span class="keyword">void</span>	(*indication)(struct usbnet *dev, <span class="keyword">void</span> *ind, <span class="keyword">int</span> indlen);</span><br><span class="line">	<span class="keyword">void</span>	(*set_rx_mode)(struct usbnet *dev);</span><br><span class="line">	<span class="keyword">int</span>		in;		<span class="comment">/* rx endpoint */</span></span><br><span class="line">	<span class="keyword">int</span>		out;		<span class="comment">/* tx endpoint */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	data;		<span class="comment">/* Misc driver specific data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Just like the other huge structure, we will only use a small part of it.</p>
<h3 id="ax88179-driver-info"><a class="markdownIt-Anchor" href="#ax88179-driver-info"></a> AX88179 Driver Info</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">driver_info</span> <span class="title">ax88179_info</span> = &#123;</span></span><br><span class="line">	.description = <span class="string">"ASIX AX88179 USB 3.0 Gigabit Ethernet"</span>,</span><br><span class="line">	.bind = ax88179_bind,</span><br><span class="line">	.unbind = ax88179_unbind,</span><br><span class="line">	.status = ax88179_status,</span><br><span class="line">	.link_reset = ax88179_link_reset,</span><br><span class="line">	.reset = ax88179_reset,</span><br><span class="line">	.<span class="built_in">stop</span> = ax88179_stop,</span><br><span class="line">	.flags = FLAG_ETHER | FLAG_FRAMING_AX,</span><br><span class="line">	.rx_fixup = ax88179_rx_fixup,</span><br><span class="line">	.tx_fixup = ax88179_tx_fixup,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ax88178a-driver-info"><a class="markdownIt-Anchor" href="#ax88178a-driver-info"></a> AX88178a Driver Info</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">driver_info</span> <span class="title">ax88178a_info</span> = &#123;</span></span><br><span class="line">	.description = <span class="string">"ASIX AX88178A USB 2.0 Gigabit Ethernet"</span>,</span><br><span class="line">	.bind = ax88179_bind,</span><br><span class="line">	.unbind = ax88179_unbind,</span><br><span class="line">	.status = ax88179_status,</span><br><span class="line">	.link_reset = ax88179_link_reset,</span><br><span class="line">	.reset = ax88179_reset,</span><br><span class="line">	.<span class="built_in">stop</span> = ax88179_stop,</span><br><span class="line">	.flags = FLAG_ETHER | FLAG_FRAMING_AX,</span><br><span class="line">	.rx_fixup = ax88179_rx_fixup,</span><br><span class="line">	.tx_fixup = ax88179_tx_fixup,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="flags"><a class="markdownIt-Anchor" href="#flags"></a> .flags</h3>
<p>In flags, we might have several bitwise flag. This is created for some special feature of each device.</p>
<p>In these two devices, we have Ethernet device feature and ASIX specific device features.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_ETHER	0x0020		<span class="comment">/* maybe use "eth%d" names */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLAG_FRAMING_AX 0x0040		<span class="comment">/* AX88772/178 packets */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="lifecycle-related-sequence"><a class="markdownIt-Anchor" href="#lifecycle-related-sequence"></a> Lifecycle-related sequence</h3>
<p>System will call the function pointed by <code>.bind</code> to initialize device. The one pointed by <code>.unbind</code> will be called to do a cleanup in the system. To reset device, system will call <code>.reset</code>. To actively stop device, <code>.stop</code> will be invoked. Linux will also use <code>.status</code> to query the device satus. And <code>.link_reset</code> can be called for link reset handling purpose.</p>
<p>These functions are so long and so device-specific that we do not need to concentrate on them. The most important functionality is transmission of packets, which is implemented by <code>.rx_fixup</code>(for receiving), and <code>.tx_fixup</code>(for sending).</p>
<h3 id="rx_fixup"><a class="markdownIt-Anchor" href="#rx_fixup"></a> .rx_fixup</h3>
<p>The function pointed by <code>.rx_fixup</code> works on doing frame stripping.</p>
<p>What’s frame stripping? These are two screenshots of an ARP network packet in USB traffic(above) and in Ethernet traffic(below), captured by Wireshark.</p>
<img src="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/rx_usb_net_packet.png" title="RX USB Ethernet Packet">
<img src="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/rx_net_packet.png" title="RX Ethernet Pacquet">
<p>We can see that the highlighted part, from 0042 to 0079 in USB traffic, is exactly the same thing. So, what has RX fixup done is clear: it tries to extract the Ethernet packet from a USB frame.</p>
<h4 id="function-prototype"><a class="markdownIt-Anchor" href="#function-prototype"></a> Function Prototype</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ax88179_rx_fixup</span><span class="params">(struct usbnet *dev, struct sk_buff *skb)</span></span>;</span><br></pre></td></tr></table></figure>
<p>The function accepts two parameters, one is the deivce, the other is the data received.</p>
<p>The type <code>struct sk_buff</code> is defined in <code>include/linux/skbuff.h</code>, and is widely used in the network modules. It’s the abbreviation of socket buffer.</p>
<h4 id="implementation-on-mainline"><a class="markdownIt-Anchor" href="#implementation-on-mainline"></a> Implementation on mainline</h4>
<p>In this chapter, we’ll take a look at every lines of this function on Linux Kernel mainline.</p>
<p>First, complying to C89, all of variables should be declared at the beginning of the scope block.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">ax_skb</span>;</span></span><br><span class="line"><span class="keyword">int</span> pkt_cnt;</span><br><span class="line">u32 rx_hdr;</span><br><span class="line">u16 hdr_off;</span><br><span class="line">u32 *pkt_hdr;</span><br></pre></td></tr></table></figure>
<p><code>ax_skb</code> is a pointer which can point to a new socket buffer instance. <code>pkt_cnt</code> is the counter of packet, which counts how many packets are there in the packet.</p>
<p><code>rx_hdr</code> can represent the header of the USB packet that we received, this variable is a 32 bits one, or 4 bytes or 4 octets. <code>pkt_hdr</code> is a pointer to unsigned 32 bits integer, literally it can point to the header of packet. <code>hdr_off</code> is an unsigned 16 bits integer, which records the offset of real header.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This check is no longer done by usbnet */</span></span><br><span class="line"><span class="keyword">if</span> (skb-&gt;len &lt; dev-&gt;net-&gt;hard_header_len)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>In current version, the driver should check the length is compliable with the device or not. <code>return 0</code> means that the packet isn’t handled correctly.</p>
<p>And then, it uses <code>skb_trim</code> to cut the last 4 bytes, reduce the length and calculate other fields in the structure.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skb_trim(skb, skb-&gt;len - <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>To know better how it works, we can take the previous packet to make an example:</p>
<img src="/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/rx_usb_net_packet.png" title="RX USB Ethernet Packet">
<p>With the trim function, the last <code>01 00 04 00</code> should be dropped.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(&amp;rx_hdr, skb_tail_pointer(skb), <span class="number">4</span>);</span><br><span class="line">le32_to_cpus(&amp;rx_hdr);</span><br></pre></td></tr></table></figure>
<p>But in fact, they are not totally dropper, the data is still their. The next step is rightly copying them into <code>rx_hdr</code>, with correspondant byte order. For example, my Linux is x86_64, so with little-endian. And the <code>01 00</code> is exactly 0x0001 in our brain. So, the number should be <code>00 40 00 01</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pkt_cnt = (u16)rx_hdr;</span><br><span class="line">hdr_off = (u16)(rx_hdr &gt;&gt; <span class="number">16</span>);</span><br></pre></td></tr></table></figure>
<p>Then, with some magic, we can assign the packet counter <code>pkt_cnt</code> and the header offset <code>hdr_off</code>. With the humain readable representation <code>00 40 00 01</code>, we could see there is one packet and the offset is 64 bytes (<code>0x40</code> in decimal).</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkt_hdr = (u32 *)(skb-&gt;data + hdr_off);</span><br></pre></td></tr></table></figure>
<p>We’ll have the header of the packet with <code>pkt_hdr</code> variable. In our case, it will point at a byte which has <code>0x40</code> offset from the beginning of the packet. We should notice that, the packet begins at <code>0x40</code>, so, with the offset, it should point at <code>0x80</code>, where there are <code>00 88 3e 00</code>.</p>
<p>Then, we’ill attemp to iterately get all network packets in this single USB packet.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (pkt_cnt--) &#123;</span><br></pre></td></tr></table></figure>
<p>As usual, do the initialization at first. We will extract the length of each packet to <code>pkt_len</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u16 pkt_len;</span><br><span class="line">le32_to_cpus(pkt_hdr);</span><br></pre></td></tr></table></figure>
<p>Extract packet length.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkt_len = (*pkt_hdr &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x1fff</span>;</span><br></pre></td></tr></table></figure>
<p>Here, we should have <code>00 3e 00 88</code> as the human readable order. So, the packet length should be <code>0x3e</code> -&gt; 62 bytes.</p>
<p>If we look at the USB-Net packet capture, we could know it’s correct!</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check CRC or runt packet */</span></span><br><span class="line"><span class="keyword">if</span> ((*pkt_hdr &amp; AX_RXHDR_CRC_ERR) ||</span><br><span class="line">	(*pkt_hdr &amp; AX_RXHDR_DROP_ERR)) &#123;</span><br><span class="line">	skb_pull(skb, (pkt_len + <span class="number">7</span>) &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">	pkt_hdr++;</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If <code>AX_RXHDR_CRC_ERR</code> or <code>AX_RXHDR_DROP_ERR</code> is set, just drop this packet because it’s not what we want. We only care the network packet.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AX_RXHDR_CRC_ERR			((u32)BIT(29))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AX_RXHDR_DROP_ERR			((u32)BIT(31))</span></span><br></pre></td></tr></table></figure>
<p>The two flags are defined at the top of source code file. We can see in our packet, the 29th bit and the 31st bit are both 0. So, just ignore the code mentioned above. We continue.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pkt_cnt == <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="comment">/* Skip IP alignment psudo header */</span></span><br><span class="line">	skb_pull(skb, <span class="number">2</span>);</span><br><span class="line">	skb-&gt;len = pkt_len;</span><br><span class="line">	skb_set_tail_pointer(skb, pkt_len);</span><br><span class="line">	skb-&gt;truesize = pkt_len + <span class="keyword">sizeof</span>(struct sk_buff);</span><br><span class="line">	ax88179_rx_checksum(skb, pkt_hdr);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If we are handling the last packet, firstly we remove the first two bytes. They are two <code>0xee</code> at the beginning. In this function, the length will also be reduced by 2. But it’s not the <code>pkt_len</code>, it’s the length field in the socket buffer instance which is reduced.</p>
<p>Then, we update the length to the right length of Network Packet and do some cleanup work. Then the stripped frame will be used by the system, as a network packet. <strong>Note: only the last packet will be “returned” by the origin socket buffer.</strong></p>
<p>But if we take a look at the end of the network packet, there are serveral bytes which are not used by the protocol itself. This will lead an error, I’ll talk about it in the <a href="/2019/12/11/Bug_AX88179_178a_USB_Ethernet_adapter_Linux_Driver/">next post</a>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ax_skb = skb_clone(skb, GFP_ATOMIC);</span><br><span class="line"><span class="keyword">if</span> (ax_skb) &#123;</span><br><span class="line">	ax_skb-&gt;len = pkt_len;</span><br><span class="line">	ax_skb-&gt;data = skb-&gt;data + <span class="number">2</span>;</span><br><span class="line">	skb_set_tail_pointer(ax_skb, pkt_len);</span><br><span class="line">	ax_skb-&gt;truesize = pkt_len + <span class="keyword">sizeof</span>(struct sk_buff);</span><br><span class="line">	ax88179_rx_checksum(ax_skb, pkt_hdr);</span><br><span class="line">	usbnet_skb_return(dev, ax_skb);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">skb_pull(skb, (pkt_len + <span class="number">7</span>) &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">pkt_hdr++;</span><br></pre></td></tr></table></figure>
<p>Finally in the loop, we know that there are still several network packets in the USB packet.</p>
<p>So we try to clone the raw packet, regulate the boundary, and return it by <code>usbnet_skb_return</code> function.</p>
<p>If there are still packets to be handled, go on.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Otherwise, the loop ends.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>In the end, if we reach here, it means there are not any more the packets to be handled. So, it “reports” to the system that we’ve finished succefully.</p>
<h3 id="tx_fixup"><a class="markdownIt-Anchor" href="#tx_fixup"></a> .tx_fixup</h3>
<p>After analysis of RX fixup, what TX fixup should do is obvious. It just wrapped the raw paquet into a USB frame, and send it to the device. The device will send it to the other side.</p>
<h4 id="function-prototype-2"><a class="markdownIt-Anchor" href="#function-prototype-2"></a> Function Prototype</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *</span></span><br><span class="line"><span class="class"><span class="title">ax88179_tx_fixup</span>(<span class="title">struct</span> <span class="title">usbnet</span> *<span class="title">dev</span>, <span class="title">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>, <span class="title">gfp_t</span> <span class="title">flags</span>)</span></span><br></pre></td></tr></table></figure>
<p>The two first parameters have the same type, and the same usage as the two in RX fixup. The last one is a set of flags, but it’s not used in the implementation. So, we neglict it.</p>
<h4 id="implementation-on-mainline-2"><a class="markdownIt-Anchor" href="#implementation-on-mainline-2"></a> Implementation on mainline</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">u32 tx_hdr1, tx_hdr2;</span><br><span class="line"><span class="keyword">int</span> frame_size = dev-&gt;maxpacket;</span><br><span class="line"><span class="keyword">int</span> mss = skb_shinfo(skb)-&gt;gso_size;</span><br><span class="line"><span class="keyword">int</span> headroom;</span><br><span class="line">tx_hdr1 = skb-&gt;len;</span><br><span class="line">tx_hdr2 = mss;</span><br></pre></td></tr></table></figure>
<p>Declarations and initializations of variables.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (((skb-&gt;len + <span class="number">8</span>) % frame_size) == <span class="number">0</span>)</span><br><span class="line">	tx_hdr2 |= <span class="number">0x80008000</span>;	<span class="comment">/* Enable padding */</span></span><br><span class="line"></span><br><span class="line">headroom = skb_headroom(skb) - <span class="number">8</span>;</span><br></pre></td></tr></table></figure>
<p><code>skb_headroom</code> returns the number of bytes of free space at the head of an sk_buff.</p>
<p>So, this is a boundary check for adding more bytes.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((skb_header_cloned(skb) || headroom &lt; <span class="number">0</span>) &amp;&amp;</span><br><span class="line">	pskb_expand_head(skb, headroom &lt; <span class="number">0</span> ? <span class="number">8</span> : <span class="number">0</span>, <span class="number">0</span>, GFP_ATOMIC)) &#123;</span><br><span class="line">	dev_kfree_skb_any(skb);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If our socket buffer is a clone or we have no more space to store stuff, we’ll fail to send.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">skb_push(skb, <span class="number">4</span>);</span><br><span class="line">cpu_to_le32s(&amp;tx_hdr2);</span><br><span class="line">skb_copy_to_linear_data(skb, &amp;tx_hdr2, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>Append the flag to the current end of packet.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">skb_push(skb, <span class="number">4</span>);</span><br><span class="line">cpu_to_le32s(&amp;tx_hdr1);</span><br><span class="line">skb_copy_to_linear_data(skb, &amp;tx_hdr1, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>Copy the length to the end of packet.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> skb;</span><br></pre></td></tr></table></figure>
<p>Return the instance.</p>
<h1 id="conclusion"><a class="markdownIt-Anchor" href="#conclusion"></a> Conclusion</h1>
<p>By analyzing this codebase, we should be able to know how a USB network device works.</p>
<p>In the <a href="/2019/12/11/Bug_AX88179_178a_USB_Ethernet_adapter_Linux_Driver/">next post</a>, I’ll talk about the serious bug which is found in this driver.</p>
<p>See you!</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>Permanent Link：</strong>
      <a href="https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/" title="AX88179_178a USB-Ethernet adapter Linux Driver" target="_blank" rel="external">https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/</a>
    </li>
    
    <!--
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
    -->
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">Inoki</span><small class="ml-1x">Student</small></a></h3>
        <div>Ph.D student in Computer Science, major in Embedded System and Telecommunication. Currently doing research in LoRa IoT Protocol.</div>
      </div>
    </figure>
  </div>
</div>


      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2713518338457470" crossorigin="anonymous"></script>
      <!-- Blog post bottom bar -->
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2713518338457470" data-ad-slot="9214609149" data-ad-format="auto" data-full-width-responsive="true"></ins>
      <script>
           (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom="">
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2019/12/09/Write-your-first-ffmpeg-program-on-Windows/" title="Write your first FFmpeg program on Windows"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2019/12/08/Install-linux-QQ-on-chromeos/" title="Install Linux QQ on ChromeOS"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,qzone,wechat,tencent,douban,diandian,facebook,twitter,google,linkedin" data-mobile-sites="weibo,qq,qzone,wechat,tencent,douban,diandian,facebook,twitter,google,linkedin"></div>
    
  </div>
  </div>
</nav>
  



</main>

  <footer class="footer" itemscope="" itemtype="http://schema.org/WPFooter">
    
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/inokinoki" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://twitter.com/IIInoki" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">

        

        

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2713518338457470" crossorigin="anonymous"></script>

    </div>
</footer>

  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   





   
    
    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'https://blog.inoki.cc/2019/12/09/AX88179_178a_USB_Ethernet_adapter_Linux_Driver/';
        
        this.page.identifier = 'AX88179_178a_USB_Ethernet_adapter_Linux_Driver';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'inokinoki' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>




  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>



    <script defer type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-108089983-2', 'auto');
ga('send', 'pageview');

</script>


    <script defer>
var _hmt = _hmt || [];

</script>



</body>
</html>